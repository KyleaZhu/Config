name: ğŸš¨ Reset Repo (Delete History)

on:
  workflow_dispatch: # ä»…å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼Œé˜²æ­¢æ„å¤–è¿è¡Œ

permissions:
  contents: write
  actions: write

jobs:
  reset-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. åˆ é™¤å†å² Actions è¿è¡Œè®°å½•
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·åå’Œä»“åº“åï¼Œæ ¼å¼: owner/repo
          REPO: ${{ github.repository }} 
        run: |
          echo "Listing runs to delete..."
          # è·å–æ‰€æœ‰è¿è¡Œè®°å½•ID (æ’é™¤æ­£åœ¨è¿è¡Œçš„è¿™ä¸€ä¸ª)
          run_ids=$(gh run list --repo $REPO --limit 1000 --json databaseId,status --jq '.[] | select(.status != "in_progress") | .databaseId')
          
          if [ -z "$run_ids" ]; then
            echo "No previous runs found."
          else
            echo "Deleting runs..."
            for run_id in $run_ids; do
              echo "Deleting Run ID: $run_id"
              gh run delete $run_id --repo $REPO
            done
          fi

      # 2. é‡ç½® Git Commit å†å²
      - name: Reset Git Commit History
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 1. åˆ›å»ºä¸€ä¸ªå­¤å„¿åˆ†æ”¯ (æ— å†å²)
          git checkout --orphan temp_branch
          
          # 2. æ·»åŠ æ‰€æœ‰å½“å‰æ–‡ä»¶
          git add -A
          
          # 3. æäº¤
          git commit -m "Initial commit (History Reset)"
          
          # 4. è·å–å½“å‰é»˜è®¤åˆ†æ”¯åç§° (é€šå¸¸æ˜¯ main æˆ– master)
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          
          # 5. å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹é»˜è®¤åˆ†æ”¯
          git push -f origin temp_branch:$DEFAULT_BRANCH
