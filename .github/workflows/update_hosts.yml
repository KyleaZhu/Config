name: Update Mihomo Hosts

on:
  schedule:
    # 北京时间每天 20:00 运行 (UTC 12:00)
    - cron: '0 12 * * *'
  workflow_dispatch: # 允许手动点击按钮运行

jobs:
  update-hosts:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写入权限来提交代码

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests ruamel.yaml

      - name: Update hosts in YAML
        shell: python
        run: |
          import requests
          from ruamel.yaml import YAML

          # 1. 定义文件路径和源地址
          target_file = 'MihomoAIO.yaml' # 你的配置文件路径
          hosts_url = 'https://raw.githubusercontent.com/521xueweihan/GitHub520/main/hosts'

          # 2. 获取 GitHub520 Hosts 内容
          print(f"Fetching hosts from {hosts_url}...")
          try:
              response = requests.get(hosts_url)
              response.raise_for_status()
              hosts_content = response.text
          except Exception as e:
              print(f"Error fetching hosts: {e}")
              exit(1)

          # 3. 解析 Hosts 内容 (格式: IP Domain) -> 转换为字典 {Domain: IP}
          new_hosts_map = {}
          for line in hosts_content.splitlines():
              line = line.strip()
              # 跳过注释和空行
              if not line or line.startswith('#'):
                  continue
              
              parts = line.split()
              if len(parts) >= 2:
                  ip = parts[0]
                  domain = parts[1]
                  new_hosts_map[domain] = ip

          print(f"Parsed {len(new_hosts_map)} hosts entries.")

          # 4. 使用 ruamel.yaml 读取目标 YAML 文件 (保留注释和格式)
          yaml = YAML(typ='rt')
          yaml.preserve_quotes = True
          yaml.width = 4096
          yaml.indent(mapping=2, sequence=4, offset=2)
    
          try:
              with open(target_file, 'r', encoding='utf-8') as f:
                  data = yaml.load(f)
          except FileNotFoundError:
              print(f"File {target_file} not found!")
              exit(1)

          def set_anchors_always_dump(obj):
              if hasattr(obj, '_yaml_anchor') and obj._yaml_anchor:
                  obj._yaml_anchor.always_dump = True
              if isinstance(obj, dict):
                  for k, v in obj.items():
                      set_anchors_always_dump(k)
                      set_anchors_always_dump(v)
              elif isinstance(obj, list):
                  for item in obj:
                      set_anchors_always_dump(item)
          set_anchors_always_dump(data)

          # 5. 更新 hosts 节点
          if 'hosts' not in data or data['hosts'] is None:
              data['hosts'] = {}

          # update() 方法会保留原有的 key ，并覆盖/新增 GitHub 的 key
          data['hosts'].update(new_hosts_map)

          # 6. 写回文件
          with open(target_file, 'w', encoding='utf-8') as f:
              yaml.dump(data, f)
          
          print("MihomoAIO.yaml updated successfully.")

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查是否有文件变动
          if [[ -n $(git status -s) ]]; then
            git add MihomoAIO.yaml
            git commit -m "chore: update github hosts in MihomoAIO.yaml"
            git push
            echo "Changes pushed to repository."
          else
            echo "No changes detected."
          fi
